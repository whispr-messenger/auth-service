name: Pipeline Monitor

on:
  workflow_run:
    workflows: ["Main CI Pipeline", "Tests & Quality", "Security Analysis", "Docker Build & Deploy"]
    types: [completed]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  monitor:
    name: Pipeline Status Monitor
    runs-on: ubuntu-latest
    
    steps:
      - name: Check workflow status
        env:
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          WORKFLOW_STATUS: ${{ github.event.workflow_run.conclusion }}
          WORKFLOW_ID: ${{ github.event.workflow_run.id }}
          HEAD_BRANCH: ${{ github.event.workflow_run.head_branch }}
        run: |
          echo "🔍 Monitoring workflow: $WORKFLOW_NAME"
          echo "📋 Status: $WORKFLOW_STATUS"
          echo "🔗 Run ID: $WORKFLOW_ID"
          echo "🌿 Branch: $HEAD_BRANCH"

      - name: Pipeline failure notification
        if: github.event.workflow_run.conclusion == 'failure'
        env:
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          WORKFLOW_BRANCH: ${{ github.event.workflow_run.head_branch }}
          WORKFLOW_SHA: ${{ github.event.workflow_run.head_sha }}
          WORKFLOW_URL: ${{ github.event.workflow_run.html_url }}
        run: |
          echo "🚨 PIPELINE FAILURE DETECTED!"
          echo "Workflow: $WORKFLOW_NAME"
          echo "Branch: $WORKFLOW_BRANCH"
          echo "Commit: $WORKFLOW_SHA"
          echo "URL: $WORKFLOW_URL"

      - name: Create failure issue
        if: github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.head_branch == 'main'
        uses: actions/github-script@v7
        env:
          WORKFLOW_NAME: ${{ github.event.workflow_run.name }}
          WORKFLOW_BRANCH: ${{ github.event.workflow_run.head_branch }}
          WORKFLOW_SHA: ${{ github.event.workflow_run.head_sha }}
          WORKFLOW_URL: ${{ github.event.workflow_run.html_url }}
          COMMIT_MESSAGE: ${{ github.event.workflow_run.head_commit.message }}
        with:
          script: |
            const title = `🚨 Pipeline Failure: ${process.env.WORKFLOW_NAME}`;
            const body = `
            ## Pipeline Failure Report
            
            **Workflow**: ${process.env.WORKFLOW_NAME}
            **Branch**: ${process.env.WORKFLOW_BRANCH}
            **Commit**: ${process.env.WORKFLOW_SHA}
            **Run URL**: ${process.env.WORKFLOW_URL}
            **Failure Time**: ${new Date().toISOString()}
            
            ### Commit Details
                        **Message**: ${process.env.COMMIT_MESSAGE}
            
            ### Actions Required
            1. Review the failed workflow in the Actions tab
            2. Check the logs for specific error details
            3. Fix the issues and re-run the workflow
            4. Close this issue once resolved
            
            ### Automatic Issue Management
            This issue will be closed automatically when the main branch pipeline succeeds again.
            `;
            
            // Check if a similar issue already exists
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['pipeline-failure', 'main-branch']
            });
            
            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['pipeline-failure', 'main-branch', 'critical']
              });
            }
            
            ### Next Steps
            1. Check the workflow logs for detailed error information
            2. Fix the issues and push a new commit
            3. This issue will be automatically closed when the pipeline passes
            
            ---
            *This issue was automatically created by the Pipeline Monitor*
            `;
            
            // Vérifier si une issue similaire existe déjà
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'pipeline-failure'
            });
            
            const similarIssue = existingIssues.data.find(issue => 
              issue.title.includes(context.payload.workflow_run.name)
            );
            
            if (!similarIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['pipeline-failure', 'bug', 'ci/cd']
              });
            }

      - name: Close success issues
        if: github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main'
        uses: actions/github-script@v7
        with:
          script: |
            // Fermer les issues de pipeline failure pour ce workflow
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'pipeline-failure'
            });
            
            for (const issue of issues.data) {
              if (issue.title.includes(context.payload.workflow_run.name)) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: `✅ Pipeline is now working! Closing this issue.\n\n**Fixed in commit**: ${context.payload.workflow_run.head_sha}`
                });
                
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
              }
            }