name: CD Pipeline

on:
  workflow_run:
    workflows: [ðŸš€ CI Pipeline]
    types: [completed]
    branches: [main]
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA to deploy (leave empty for latest)'
        required: false
        type: string

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}/auth-service

jobs:
  update-deployment:
    if: ${{ (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push') || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    name: Update Deployment Manifest

    permissions:
      contents: write

    steps:
      - name: Generate GitHub App Token
        id: generate_token
        uses: tibdex/github-app-token@v2
        with:
          app_id: ${{ secrets.ACTIONS_CD }}
          private_key: ${{ secrets.ACTIONS_CD_PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ steps.generate_token.outputs.token }}

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Update image tag in deployment
        run: |
          # Determine the commit SHA based on trigger type
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use input or current commit
            if [ -n "${{ inputs.commit_sha }}" ]; then
              COMMIT_SHA="${{ inputs.commit_sha }}"
              echo "Using manually provided commit SHA: $COMMIT_SHA"
            else
              COMMIT_SHA="${{ github.sha }}"
              echo "Using current commit SHA: $COMMIT_SHA"
            fi
          else
            # Automatic trigger from CI workflow
            COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
            # If empty, use github.sha as fallback
            if [ -z "$COMMIT_SHA" ]; then
              COMMIT_SHA="${{ github.sha }}"
              echo "Using github.sha as fallback: $COMMIT_SHA"
            fi
          fi

          # Extract short SHA safely using printf (7 characters, matching docker metadata-action default)
          SHORT_SHA=$(printf "%.7s" "$COMMIT_SHA")
          
          # Use the short SHA tag format that matches the CI docker workflow
          # The docker.yml workflow creates tags with "type=sha,format=short" which produces: sha-<short_sha>
          IMAGE_TAG="sha-${SHORT_SHA}"

          # Build the full image reference with lowercase (OCI requirement)
          FULL_IMAGE="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          FULL_IMAGE=$(echo "${FULL_IMAGE}" | tr '[:upper:]' '[:lower:]')

          echo "Commit SHA: $COMMIT_SHA"
          echo "Short SHA: $SHORT_SHA"
          echo "Image tag: $IMAGE_TAG"
          echo "Updating deployment image to: ${FULL_IMAGE}"

          # Update the deployment manifest using yq
          yq -i ".spec.template.spec.containers[0].image = \"${FULL_IMAGE}\"" k8s/deployment.yaml

      - name: Verify update
        run: |
          echo "Updated deployment manifest:"
          yq '.spec.template.spec.containers[0].image' k8s/deployment.yaml

      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Check if there are changes to commit
          if git diff --quiet k8s/deployment.yaml; then
            echo "No changes to commit"
            exit 0
          fi

          # Determine commit SHA for commit message
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TRIGGER_SHA="${{ inputs.commit_sha }}"
            if [ -z "$TRIGGER_SHA" ]; then
              TRIGGER_SHA="${{ github.sha }}"
            fi
            COMMIT_MSG="ðŸ”§ chore(deploy): update deployment image to latest build

          Updated by CD workflow (manual trigger) for commit: ${TRIGGER_SHA}"
          else
            COMMIT_MSG="ðŸ”§ chore(deploy): update deployment image to latest build

          Updated by CD workflow for commit: ${{ github.event.workflow_run.head_sha }}"
          fi

          git add k8s/deployment.yaml
          git commit -m "${COMMIT_MSG}"

          git push https://x-access-token:${{ steps.generate_token.outputs.token }}@github.com/${{ github.repository }}.git main